## 使用缓存的感受

有的时候我们时常遇到一些热数据读多写少，这个时候我们就需要使用缓存来提升速度，而不是查询数据库
但是使用何种缓存，如何使用一直是我不理解的地方（依然不理解）

# 使用何种缓存

* hibernate 二级缓存
* spring boot cache 提供的自定义缓存

| 缓存类型 | 好处                                 | 坏处                                                       |
| -------- | ------------------------------------ | ---------------------------------------------------------- |
| 二级缓存 | 无需手动管理缓存                     | 恶心的 `join` 以及无法预测的 N+1 带来的缓存爆炸问题       |
| 自定义 cache    | 灵活性高，可以自定义缓存的时机，条件 | 手动操作带来的就是无序的控制，而且没有切实的规范和最佳实践 |

> * 缓存爆炸，在上一家公司的时候，使用的 memecache 作为 hibernate 二级缓存的存储方式，并且是与服务 tomcat 放在同一台服务器上，时常会出现的问题就是其不够用，内存捉襟见肘，进入 memecahe 一看都是类似 md5 的 key，无法排查到底是哪个部分 sql 请求的数据过大，往往最后都是手动全清    
> * 混乱的手动缓存，当然使用过 redis 来手动管理缓存，但是我写的时候发现在每一个 get 的地方设置缓存，那么在同样的 set 地方就要清空缓存，带来的结果就是代码和缓存控制耦合严重，写起来非常令人烦躁

# 无法直接使用缓存
某些地方由于并发高（秒杀库存数量），或者数据要求一定要准确（库存数据，消费金额），这样的地方一般无法直接使用缓存，会带来脏数据的问题，但是如果一定要缓存，有如下解决办法
1. 延迟双清，依据在写时缓存的特性，写入时清除一遍，等待若干秒再异步清除一遍
	* 但是这样的方式还是没法做到 ACID，还是会在小概率情况下遇到脏数据的问题
	* 参见 [v2ex](https://v2ex.com/t/837806#reply10) 的一些讨论













